<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>이미지 업로드</title>
<style>
  body { font-family: Arial; margin:20px; background:#f4f4f9; }
  .container { max-width:700px; margin:0 auto; padding:20px; background:white; border-radius:10px; text-align:center; }
  #displayContainer { display:flex; justify-content:center; align-items:center; min-height:80vh; flex-direction:column; }
  .context-menu, .format-dropdown {
    position:absolute; background:white; border:1px solid #ccc; border-radius:5px;
    box-shadow:0 2px 5px rgba(0,0,0,.2); z-index:9999;
  }
  .context-menu-item, .format-item { padding:8px 12px; cursor:pointer; }
  .context-menu-item:hover, .format-item:hover { background:#eee; }
</style>
</head>
<body>

<div class="container" id="uploadContainer">
  <h1>이미지 업로드</h1>
  <input type="file" id="fileInput" accept="image/*" required />
  <button id="uploadButton">업로드</button>
  <div id="message"></div>

  <div id="linkContainer" style="display:none; margin-top:20px;">
    <a id="imageLink" target="_blank">이미지 바로가기</a>
    <button id="copyButton">공유 링크 복사</button>
  </div>
</div>

<div class="container" id="displayContainer" style="display:none;">
  <img id="displayImage" style="max-width:100%; max-height:80vh; border-radius:10px;" />
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(location.search);
  const id = params.get("id");
  const name = params.get("name");
  const raw = params.get("raw");

  if (id && name && raw === "1") {
    window.location.href = `/api/image?id=${id}&name=${name}`;
    return;
  }

  if (id && name) {
    document.getElementById("uploadContainer").style.display = "none";
    const img = document.getElementById("displayImage");
    img.src = `/api/image?id=${id}&name=${name}`;
    document.getElementById("displayContainer").style.display = "flex";
    setupContextMenu(img, id, name);
  }
});

document.getElementById("uploadButton").onclick = async () => {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return alert("파일을 선택하세요.");

  const message = document.getElementById("message");
  message.textContent = "업로드 중...";

  const res = await fetch(`/api/upload`, {
    method: "POST",
    headers: { "x-file-name": file.name },
    body: file
  });

  const { id, name } = await res.json();
  const shareUrl = `${location.origin}?id=${id}&name=${name}`;

  document.getElementById("linkContainer").style.display = "block";
  document.getElementById("imageLink").href = shareUrl;
  document.getElementById("copyButton").onclick = () =>
    navigator.clipboard.writeText(shareUrl).then(() => alert("복사됨"));

  message.textContent = "업로드 완료!";
};

function setupContextMenu(img, id, name) {
  const url = `${location.origin}?id=${id}&name=${name}`;
  const rawUrl = `${location.origin}?id=${id}&name=${name}&raw=1`;

  const menu = document.createElement("div");
  menu.className = "context-menu";
  document.body.appendChild(menu);

  img.addEventListener("contextmenu", e => {
    e.preventDefault();
    menu.innerHTML = "";

    [
      { text:"이미지 다운로드", action:()=>window.open(rawUrl) },
      { text:"공유 링크 복사", action:()=>navigator.clipboard.writeText(url) },
      { text:"이미지 RAW 링크 복사", action:()=>navigator.clipboard.writeText(rawUrl) }
    ].forEach(a=>{
      const item=document.createElement("div");
      item.className="context-menu-item";
      item.textContent=a.text;
      item.onclick=a.action;
      menu.appendChild(item);
    });

    menu.style.top=e.pageY+"px";
    menu.style.left=e.pageX+"px";
    menu.style.display="block";
  });

  document.addEventListener("click",()=>menu.style.display="none");
}
</script>

</body>
</html>
