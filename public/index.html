<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>멀티 미디어 업로드 & 공유</title>
  <style>
    body { margin:0; padding:1rem; font-family:sans-serif; background:#fafafa }
    .container { max-width:800px; margin:0 auto }
    h1 { text-align:center; margin-bottom:1rem }

    #upload-ui { display:none }
    .card {
      background:#fff; padding:1.5rem; border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .field { margin-bottom:1rem }
    .field label { display:block; margin-bottom:0.3rem; font-weight:bold }
    .field input[type="text"],
    .field input[type="file"] {
      width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;
    }
    .btn {
      width:100%; padding:0.75rem; background:#0070f3; color:#fff;
      border:none; border-radius:6px; font-size:1rem; cursor:pointer;
    }
    .btn:disabled { background:#999; cursor:not-allowed }
    .status { margin-top:0.5rem; font-size:0.9rem; color:#333 }

    #share-ui { display:none }
    .media-list {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(200px,1fr));
      gap:1rem;
    }
    .media-item {
      width:100%; border:1px solid #ddd; border-radius:6px;
      background:#fff;
    }
    .media-item video,
    .media-item audio { width:100% }

    .context-menu {
      position:fixed; display:none; background:#fff;
      border:1px solid #ccc; box-shadow:0 2px 6px rgba(0,0,0,0.2);
      border-radius:4px; z-index:1000; padding:0.25rem 0;
    }
    .context-menu.visible { display:block }
    .context-menu ul { margin:0; padding:0; list-style:none }
    .context-menu li {
      padding:0.5rem 1.5rem; cursor:pointer; white-space:nowrap;
    }
    .context-menu li:hover { background:#f0f0f0 }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="page-title"></h1>

    <!-- 업로드 UI -->
    <div id="upload-ui">
      <div class="card">
        <div class="field">
          <label for="customName">커스텀 링크 이름 (선택)</label>
          <input type="text" id="customName" placeholder="예: 내_앨범_2025"/>
        </div>
        <div class="field">
          <label for="files">파일 선택 (이미지·오디오·동영상)</label>
          <input type="file" id="files" multiple accept="image/*,audio/*,video/*"/>
        </div>
        <button id="uploadBtn" class="btn" disabled>업로드 시작</button>
        <div id="status" class="status"></div>
        <div id="links" class="status"></div>
      </div>
    </div>

    <!-- 공유 UI -->
    <div id="share-ui">
      <div class="media-list" id="media-list"></div>
    </div>
  </div>

  <!-- 우클릭 메뉴 (이미지 전용) -->
  <nav id="context-menu" class="context-menu">
    <ul>
      <li data-action="copy">이미지 복사</li>
      <li data-action="copy-link">이미지 링크 복사</li>
      <li data-action="download">다운로드</li>
      <li data-action="download-as">원하는 형식으로 다운로드</li>
    </ul>
  </nav>

  <script>
  (async () => {
    const BASE = '/';
    const path = window.location.pathname;//window.location.href.replace(/\/+$/,'');
    console.log(path)
    const uploadUI = document.getElementById('upload-ui');
    const shareUI  = document.getElementById('share-ui');
    const titleEl  = document.getElementById('page-title');

    if (path === BASE) {
      // —— 업로드 모드 —— 
      titleEl.textContent = '멀티 미디어 업로드';
      uploadUI.style.display = 'block';

      const fileInput = document.getElementById('files');
      const nameInput = document.getElementById('customName');
      const uploadBtn = document.getElementById('uploadBtn');
      const statusDiv = document.getElementById('status');
      const linksDiv  = document.getElementById('links');
      let files = [];

      fileInput.addEventListener('change', e => {
        files = Array.from(e.target.files);
        uploadBtn.disabled = !files.length;
        statusDiv.textContent = '';
        linksDiv.innerHTML = '';
      });

      uploadBtn.addEventListener('click', async () => {
        if (!files.length) return;
        const raw = nameInput.value.trim();
        // 한국어 허용: 한글 음절(uAC00–uD7A3) 포함
        const customName = raw
          ? raw.replace(/[^0-9a-zA-Z\uAC00-\uD7A3\-]/g, '_')
          : '';
        uploadBtn.disabled = true;
        statusDiv.textContent = `업로드 중 (0/${files.length})`;
        linksDiv.innerHTML = '';

        const ids = [];
        for (let i = 0; i < files.length; i++) {
          const f = files[i];
          const dataUrl = await new Promise((res,rej) => {
            const r = new FileReader();
            r.onload = () => res(r.result);
            r.onerror = rej;
            r.readAsDataURL(f);
          });
          //console.log(dataUrl)
          try {
            const resp = await fetch('https://img.kkomaweb.com/upload', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                data: dataUrl,
                filename: `${Date.now()}_${f.name}`,
                mimeType: f.type,
                customName
              })
            });
            const j = await resp.json();
            if (!j.url) throw '';
            ids.push(j.url.split('/').pop());
          } catch {
            linksDiv.innerHTML += `<div>❌ ${f.name} 업로드 실패</div>`;
          }
          statusDiv.textContent = `업로드 중 (${i+1}/${files.length})`;
        }

        if (customName) {
          linksDiv.innerHTML = `
            ✅ 커스텀 링크:<br/>
            <a href="https://img.kkomaweb.com/${customName}" target="_blank">
              https://img.kkomaweb.com/${customName}
            </a>`;
        } else {
          linksDiv.innerHTML = '🔗 기본 링크 목록:<br/>';
          ids.forEach(id => {
            linksDiv.innerHTML += `
              <a href="https://img.kkomaweb.com/${id}" target="_blank">
                https://img.kkomaweb.com/${id}
              </a><br/>`;
          });
        }
        statusDiv.textContent = '완료!';
        uploadBtn.disabled = false;
      });

    } else {// if (path != "/") {//startsWith(BASE + '/')
      // —— 공유 모드 —— 
      //const key = decodeURIComponent(path.slice((BASE + '/').length));
      const key = decodeURIComponent(path.replace("/", ""));
      titleEl.textContent = '공유 미디어 보기';
      shareUI.style.display = 'block';

      let items = [];
      try {
        const res = await fetch(`https://img.kkomaweb.com/api/links/${encodeURIComponent(key)}`);
        items = res.ok ? (await res.json()).files : [{ filename: key, mimeType: '' }];
      } catch {
        items = [{ filename: key, mimeType: '' }];
      }

      const list = document.getElementById('media-list');
      items.forEach(item => {
        const ext = item.filename.split('.').pop().toLowerCase();
        let el;
        if (item.mimeType.startsWith('video') || ['mp4','webm','ogg'].includes(ext)) {
          el = document.createElement('video'); el.controls = true;
        } else if (item.mimeType.startsWith('audio') || ['mp3','wav','aac','ogg'].includes(ext)) {
          el = document.createElement('audio'); el.controls = true;
        } else {
          el = document.createElement('img');
        }
        el.src = `https://img.kkomaweb.com/file/${item.filename}?raw=1`;
        el.dataset.filename = item.filename;
        el.classList.add('media-item');
        list.appendChild(el);
      });

      // 우클릭 메뉴 (이미지 전용)
      const menu = document.getElementById('context-menu');
      let targetImg = null;
      list.addEventListener('contextmenu', e => {
        if (e.target.tagName !== 'IMG') return;
        e.preventDefault();
        targetImg = e.target;
        menu.style.top  = e.clientY + 'px';
        menu.style.left = e.clientX + 'px';
        menu.classList.add('visible');
      });
      document.addEventListener('click', () => menu.classList.remove('visible'));
      menu.addEventListener('click', async e => {
        const action = e.target.dataset.action;
        const fn = targetImg.dataset.filename;
        const rawUrl = `https://img.kkomaweb.com/file/${fn}?raw=1`;
        const dlBase = `https://img.kkomaweb.com/file/${fn}?download=1`;

        if (action === 'copy') {
          const blob = await fetch(rawUrl).then(r=>r.blob());
          await navigator.clipboard.write([ new ClipboardItem({ [blob.type]: blob }) ]);
        }
        if (action === 'copy-link') {
          await navigator.clipboard.writeText(rawUrl);
        }
        if (action === 'download') {
          const a = document.createElement('a');
          a.href = dlBase; a.download = fn; a.click();
        }
        if (action === 'download-as') {
          const ext = prompt('확장자 입력 (png, jpg, mp4, mp3 등):', fn.split('.').pop());
          if (ext) {
            const a = document.createElement('a');
            a.href = dlBase + `&format=${encodeURIComponent(ext)}`;
            a.download = `file.${ext}`; a.click();
          }
        }
        menu.classList.remove('visible');
      });
    }
  })();
  </script>
</body>
</html>
