<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>이미지 업로드</title>
<style>
  :root {
    --primary:#4A75FF;
    --primary-hover:#3454c4;
    --bg:#eef1f7;
    --card-bg:rgba(255,255,255,0.65);
  }

  body {
    font-family: "Pretendard", Arial, sans-serif;
    background: var(--bg);
    margin:0; padding:0;
    display:flex; justify-content:center; align-items:center;
    min-height:100vh;
  }

  .container {
    width:90%; max-width:650px;
    padding:30px;
    background:var(--card-bg);
    backdrop-filter: blur(15px);
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.5);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    text-align:center;
    animation: fadeIn .4s ease-out;
  }

  @keyframes fadeIn {
    from { opacity:0; transform:translateY(10px); }
    to { opacity:1; transform:translateY(0); }
  }

  h1 {
    margin-bottom:18px;
    font-size:28px;
    font-weight:700;
    color:#222;
  }

  #fileInput {
    padding:12px;
    width:100%;
    margin-top:15px;
    border-radius:12px;
    border:1px solid #ddd;
    background:white;
    transition:.2s;
  }
  #fileInput:hover {
    border-color: var(--primary);
  }

  button {
    padding:14px 24px;
    background:var(--primary);
    color:white;
    border:none;
    margin-top:18px;
    border-radius:12px;
    cursor:pointer;
    font-size:16px;
    font-weight:600;
    transition:.2s;
    width:100%;
  }
  button:hover {
    background:var(--primary-hover);
  }

  #message {
    margin-top:15px;
    font-size:15px;
    font-weight:600;
    color:#444;
  }

  #linkContainer {
    margin-top:25px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  #imageLink {
    background:white;
    padding:12px 18px;
    border-radius:10px;
    text-decoration:none;
    display:block;
    color:var(--primary);
    font-weight:700;
    transition:.2s;
  }
  #imageLink:hover {
    background:#dfe7ff;
  }

  /* 이미지 뷰 */
  #displayContainer {
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:80vh;
    flex-direction:column;
  }

  #displayImage {
    max-width:100%;
    max-height:75vh;
    border-radius:15px;
    box-shadow:0 8px 20px rgba(0,0,0,0.18);
    cursor:pointer;
    transition:.2s;
  }
  #displayImage:hover {
    transform:scale(1.01);
  }

  /* 우클릭 메뉴 */
  .context-menu {
    position:absolute;
    background:white;
    border-radius:10px;
    border:1px solid #ccc;
    box-shadow:0 6px 18px rgba(0,0,0,0.15);
    overflow:hidden;
    min-width:180px;
  }

  .context-menu-item {
    padding:12px 15px;
    transition:.18s;
    font-size:15px;
    cursor:pointer;
  }
  .context-menu-item:hover {
    background:#f1f4ff;
    color:var(--primary);
  }

  .format-dropdown {
    position:absolute;
    background:white;
    border-radius:10px;
    border:1px solid #ccc;
    overflow:hidden;
  }
  .format-item {
    padding:10px 14px;
    cursor:pointer;
    font-size:15px;
  }
  .format-item:hover {
    background:#e8ecff;
  }
</style>
</head>
<body>

<div class="container" id="uploadContainer">
  <h1>이미지 업로드</h1>
  <input type="file" id="fileInput" accept="image/*" required />
  <button id="uploadButton">업로드</button>
  <div id="message"></div>

  <div id="linkContainer" style="display:none;">
    <a id="imageLink" target="_blank">이미지 바로가기</a>
    <button id="copyButton">공유 링크 복사</button>
  </div>
</div>

<div class="container" id="displayContainer" style="display:none;">
  <img id="displayImage"/>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(location.search);
  const id = params.get("id");
  const name = params.get("name");
  const raw = params.get("raw");

  if (id && name && raw === "1") {
    window.location.href = `/api/image?id=${id}&name=${name}`;
    return;
  }

  if (id && name) {
    document.getElementById("uploadContainer").style.display = "none";

    const img = document.getElementById("displayImage");
    img.src = `/api/image?id=${id}&name=${name}`;
    document.getElementById("displayContainer").style.display = "flex";

    setupContextMenu(img, id, name);
  }
});

document.getElementById("uploadButton").onclick = async () => {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return alert("파일을 선택하세요.");

  const message = document.getElementById("message");
  message.textContent = "업로드 중...";
  const encodedName = btoa(unescape(encodeURIComponent(file.name)));
  
  const res = await fetch(`/api/upload`, {
    method:"POST",
    headers:{ "x-file-name": encodedName },
    body:file
  });

  const { id, name } = await res.json();
  const shareUrl = `${location.origin}?id=${id}&name=${name}`;

  document.getElementById("linkContainer").style.display = "flex";
  document.getElementById("imageLink").href = shareUrl;
  document.getElementById("copyButton").onclick = () =>
    navigator.clipboard.writeText(shareUrl).then(()=>alert("공유 링크 복사됨"));

  message.textContent = "업로드 완료!";
};

function setupContextMenu(img, id, name) {
  const rawUrl = `${location.origin}/api/image?id=${id}&name=${name}`;
  const shareUrl = `${location.origin}?id=${id}&name=${name}`;

  const menu = document.createElement("div");
  menu.className = "context-menu";
  document.body.appendChild(menu);

  img.addEventListener("contextmenu", e => {
    e.preventDefault();
    menu.innerHTML = "";

    [
      { text:"이미지 다운로드", action:()=>window.open(rawUrl) },
      { text:"공유 링크 복사", action:()=>navigator.clipboard.writeText(shareUrl) },
      { text:"RAW 이미지 링크 복사", action:()=>navigator.clipboard.writeText(rawUrl) }
    ].forEach(a=>{
      const item=document.createElement("div");
      item.className="context-menu-item";
      item.textContent=a.text;
      item.onclick=a.action;
      menu.appendChild(item);
    });

    menu.style.top=e.pageY+"px";
    menu.style.left=e.pageX+"px";
    menu.style.display="block";
  });

  document.addEventListener("click",()=>menu.style.display="none");
}
</script>

</body>
</html>
