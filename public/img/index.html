<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>공유된 이미지</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .media-item { max-width: 90%; margin: 1rem 0; }
    #progress { margin-top: 1rem; }
    .context-menu { position:absolute; display:none; background:#fff; border:1px solid #ccc; border-radius:5px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
    .context-menu.visible { display:block; }
    .context-menu ul { list-style:none; margin:0; padding:0; }
    .context-menu li { padding:8px 12px; cursor:pointer; }
    .context-menu li:hover { background:#f0f0f0; }
  </style>
</head>
<body>

<!-- <h1>파일 업로드 & 공유</h1>

<input type="file" id="fileInput" multiple>
<button id="uploadBtn">업로드</button>
<div id="progress"></div>
<div id="uploadedLinks"></div>

<hr>
 -->
<div id="media-list"></div>

<nav id="context-menu" class="context-menu">
  <ul>
    <li data-action="copy">복사</li>
    <li data-action="copy-link">링크 복사</li>
    <li data-action="download">다운로드</li>
  </ul>
</nav>

<script>
(async () => {
  const path = window.location.pathname;
  const key = decodeURIComponent(path.replace("/", ""));
  const API_BASE = "https://img.kkomaweb.com";

  // // 업로드 관련
  // const input = document.getElementById('fileInput');
  // const uploadBtn = document.getElementById('uploadBtn');
  // const progress = document.getElementById('progress');
  // const uploadedLinks = document.getElementById('uploadedLinks');

  // uploadBtn.addEventListener('click', async () => {
  //   const files = input.files;
  //   if (!files.length) return alert('파일을 선택하세요.');

  //   uploadedLinks.innerHTML = '';
  //   progress.textContent = '';

  //   for (let i = 0; i < files.length; i++) {
  //     const file = files[i];
  //     const reader = new FileReader();

  //     reader.onload = async () => {
  //       try {
  //         const res = await fetch(`${API_BASE}/upload`, {
  //           method: 'POST',
  //           headers: { 'Content-Type': 'application/json' },
  //           body: JSON.stringify({
  //             filename: file.name,
  //             mimeType: file.type,
  //             data: reader.result
  //           })
  //         });
  //         const json = await res.json();
  //         if (json.success) {
  //           const link = document.createElement('a');
  //           link.href = `https://img.kkomaweb.com/${json.url.split('/').pop()}`;
  //           link.target = '_blank';
  //           link.textContent = `공유 링크 (${file.name})`;
  //           uploadedLinks.appendChild(link);
  //           uploadedLinks.appendChild(document.createElement('br'));
  //         } else {
  //           uploadedLinks.innerHTML += `<div>❌ ${file.name} 실패</div>`;
  //         }
  //       } catch (err) {
  //         console.error(err);
  //         uploadedLinks.innerHTML += `<div>❌ ${file.name} 에러</div>`;
  //       }
  //       progress.textContent = `${i + 1}/${files.length} 완료`;
  //     };

  //     reader.readAsDataURL(file);
  //     progress.textContent = `업로드 중... (${i + 1}/${files.length})`;
  //   }
  // });

  // 공유 링크 열기
  if (key) {
    try {
      const res = await fetch(`${API_BASE}/api/links/${encodeURIComponent(key)}`);
      if (!res.ok) throw new Error();
      const meta = await res.json();
      const mediaList = document.getElementById('media-list');

      const ext = (meta.filename || '').split('.').pop().toLowerCase();
      let el;
      if (meta.mimeType.startsWith('video') || ['mp4','webm','ogg'].includes(ext)) {
        el = document.createElement('video');
        el.controls = true;
      } else if (meta.mimeType.startsWith('audio') || ['mp3','wav','aac','ogg'].includes(ext)) {
        el = document.createElement('audio');
        el.controls = true;
      } else {
        el = document.createElement('img');
      }

      el.src = `${API_BASE}/file/${encodeURIComponent(key)}?raw=1`;
      el.dataset.key = key;
      el.classList.add('media-item');
      mediaList.appendChild(el);

      // 우클릭
      const menu = document.getElementById('context-menu');
      let targetEl = null;
      mediaList.addEventListener('contextmenu', e => {
        if (!['IMG','VIDEO','AUDIO'].includes(e.target.tagName)) return;
        e.preventDefault();
        targetEl = e.target;
        menu.style.top = e.clientY + 'px';
        menu.style.left = e.clientX + 'px';
        menu.classList.add('visible');
      });
      document.addEventListener('click', () => menu.classList.remove('visible'));
      menu.addEventListener('click', async e => {
        const action = e.target.dataset.action;
        if (!action || !targetEl) return;
        const fileKey = targetEl.dataset.key;
        const rawUrl = `${API_BASE}/file/${encodeURIComponent(fileKey)}?raw=1`;
        const downloadUrl = `${API_BASE}/file/${encodeURIComponent(fileKey)}?download=1`;

        if (action === 'copy') {
          const blob = await fetch(rawUrl).then(r => r.blob());
          await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
        }
        if (action === 'copy-link') {
          await navigator.clipboard.writeText(window.location.origin + `/${fileKey}`);
        }
        if (action === 'download') {
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = meta.filename || 'file';
          document.body.appendChild(a);
          a.click();
          a.remove();
        }

        menu.classList.remove('visible');
      });
    } catch (err) {
      console.error(err);
      document.getElementById('media-list').innerHTML = "<p>미디어를 찾을 수 없습니다.</p>";
    }
  }
})();
</script>

</body>
</html>
